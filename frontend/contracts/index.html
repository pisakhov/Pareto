{% extends "base.html" %}

{% block title %}Pareto - Contracts{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto mb-8">
    <div class="bg-card border border-border rounded-xl shadow-sm overflow-hidden">
        <!-- Header with gradient background matching the design system -->
        <div class="p-6 border-b border-border bg-gradient-to-r from-[#023047]/5 to-[#023047]/10">
            <div class="flex items-start justify-between gap-6">
                <!-- Left side: Icon, Title, and Description -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-4">
                        <!-- Icon -->
                        <div class="p-2.5 bg-white rounded-lg border border-slate-200 shadow-sm">
                            <svg class="w-6 h-6 text-[#023047]" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                        </div>

                        <!-- Title and Content -->
                        <div class="flex-1 min-w-0">
                            {% if current_process %}
                            <h1 class="text-3xl font-bold tracking-tight text-slate-900">
                                {{ current_process.process_name }}
                            </h1>
                            <p class="text-sm text-slate-600 mt-1.5">
                                {{ current_process.description|default("No description available") }}
                            </p>
                            {% else %}
                            <h1 class="text-3xl font-bold tracking-tight text-slate-900">
                                All Contracts
                            </h1>
                            <p class="text-sm text-slate-600 mt-1.5">Manage and configure your provider contracts</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Right side: Action Buttons -->
                <div class="flex items-center gap-3 flex-shrink-0">
                    <!-- View Mode Toggle -->
                    <button id="viewModeToggle" onclick="window.processGraphView?.toggleView()"
                        class="view-toggle-btn p-2.5 bg-white border border-border rounded-lg hover:bg-accent transition-all duration-200 shadow-sm flex items-center justify-center text-muted-foreground group"
                        title="Toggle Menu View">
                        <svg class="w-4 h-4 text-slate-700 group-hover:text-foreground transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>

                    <!-- Manage Processes Button -->
                    <button onclick="showProcessModal()"
                        class="inline-flex items-center gap-2 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700 shadow-md hover:shadow-lg rounded-lg">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <line x1="3" y1="9" x2="21" y2="9" />
                            <line x1="9" y1="21" x2="9" y2="9" />
                        </svg>
                        <span>Manage Processes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Graph Navigation -->
    {% if processes %}
    <div class="mb-6">
        <div class="bg-card rounded-lg p-4 relative min-h-[240px]">
            <!-- Graph View -->
            <div id="processGraphNav" style="height: 200px; position: relative;"
                class="transition-opacity duration-200">
                <svg class="w-full h-full" style="cursor: default;">
                    <defs>
                        <filter id="node-shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1" />
                        </filter>
                        <marker id="arrowhead-nav" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8"
                            markerHeight="8" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 L 3 5 z" fill="#94a3b8" />
                        </marker>
                    </defs>
                    <g id="connectionsLayerNav"></g>
                    <g id="nodesLayerNav"></g>
                </svg>
            </div>

            <!-- Menu View -->
            <div id="processMenuView" class="hidden absolute inset-0 bg-card rounded-lg p-4 overflow-y-auto z-10">
                <!-- Grid will be rendered here -->
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Contracts Grid Component -->
    {% include "contracts/components/pricing-grid.html" %}
</div>

<!-- Provider Modal -->
<div id="providerModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    role="dialog" aria-modal="true" aria-labelledby="providerModalTitle">
    <div class="bg-card rounded-lg p-6 w-full max-w-md">
        <h3 id="providerModalTitle" class="text-lg font-semibold mb-4">
            <span id="providerTitleText">Add Provider</span>
            <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded">comp #80124jjj</span>
        </h3>
        <form id="providerForm" aria-label="Provider form">
            <input type="hidden" id="providerId" name="provider_id">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Company Name *</label>
                    <input type="text" id="companyName" name="company_name" required
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Details</label>
                    <textarea id="details" name="details" rows="3"
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Status</label>
                    <div class="flex items-center mt-1">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="providerStatusToggle" class="sr-only peer" checked>
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#023047]">
                            </div>
                            <span class="ml-3 text-sm font-medium text-slate-700" id="providerStatusLabel">Active</span>
                        </label>
                        <input type="hidden" id="providerStatus" name="status" value="active">
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="window.modalManager.closeProviderModal()"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Cancel
                </button>
                <button type="submit"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 bg-[#023047] text-white hover:bg-[#023047]/90">
                    Save Provider
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Item Modal -->
<div id="itemModal" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden flex items-center justify-center p-4"
    role="dialog" aria-modal="true" aria-labelledby="itemModalTitle">
    <div class="bg-card rounded-lg w-full max-w-5xl flex flex-col" style="max-height: 90vh;">
        <div class="p-6 border-b border-border flex-shrink-0">
            <h3 id="itemModalTitle" class="text-lg font-semibold">
                <span id="itemTitleText">Add Item</span>
                <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded">comp
                    #4x5rgmq</span>
            </h3>
        </div>
        <form id="itemForm" aria-label="Item form" class="flex flex-col flex-1 min-h-0">
            <input type="hidden" id="itemId" name="item_id">
            <div class="space-y-4 p-6 overflow-y-auto flex-1">
                <div>
                    <div class="flex items-center justify-between mb-1">
                        <label class="block text-sm font-medium">Process *</label>
                        <span class="text-xs text-muted-foreground">Item applies to selected process only</span>
                    </div>
                    <select id="itemProcess" name="process_id" required
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent">
                        <option value="">Select a process</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Item Name *</label>
                    <input type="text" id="itemName" name="item_name" required placeholder="e.g., FICO Score"
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="itemDescription" name="description" rows="3"
                        placeholder="Brief description of the item"
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"></textarea>
                </div>
                <!-- Provider Offers Section -->
                <div class="border-t border-border pt-4 mt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-semibold text-foreground">Provider Offers</h3>
                        <span class="text-xs text-muted-foreground">Add providers and set tier prices</span>
                    </div>

                    <!-- Add Provider Control -->
                    <div id="addProviderControl" class="flex items-center gap-2 mb-4">
                        <select id="providerSelect"
                            class="flex-1 px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent">
                            <option value="">Select a provider</option>
                        </select>
                        <button type="button" id="addProviderBtn"
                            class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-600/90 whitespace-nowrap">
                            Add Provider
                        </button>
                    </div>

                    <!-- All Providers Added Message -->
                    <div id="allProvidersAddedMsg"
                        class="hidden mb-4 px-4 py-3 rounded-md bg-slate-50 border border-slate-200 text-slate-700">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="font-medium">All providers have been added to this item</span>
                        </div>
                    </div>

                    <!-- Validation Message -->
                    <div id="offerValidationMsg" class="hidden text-sm text-red-600 mb-2">Enter all tier prices</div>

                    <!-- Provider Offers Container (horizontal grid layout) -->
                    <div id="providerOffersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p class="text-sm text-muted-foreground text-center py-4 col-span-full">No providers added yet
                        </p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Status</label>
                    <div class="flex items-center mt-1">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="itemStatusToggle" class="sr-only peer" checked>
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#023047]">
                            </div>
                            <span class="ml-3 text-sm font-medium text-slate-700" id="itemStatusLabel">Active</span>
                        </label>
                        <input type="hidden" id="itemStatus" name="status" value="active">
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center p-6 border-t border-border bg-card flex-shrink-0">
                <button type="button" id="itemDeleteBtn" onclick="window.formHandler.deleteItemFromModal()"
                    class="hidden inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 hover:text-red-800 h-10 px-4 py-2">
                    Delete
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="window.modalManager.closeItemModal()"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Cancel
                    </button>
                    <button type="submit"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 bg-slate-600 text-white hover:bg-slate-600/90">
                        Save Item
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Process Modal with Graph Editor -->
<div id="processModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" role="dialog" aria-modal="true"
    aria-labelledby="processModalTitle">
    <div class="bg-card w-full h-full flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-border flex items-center justify-between">
            <div>
                <h3 id="processModalTitle" class="text-2xl font-bold">
                    Process Graph Editor
                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded">comp
                        #123nf343</span>
                </h3>
                <p class="text-sm text-muted-foreground mt-1">Design process flows with drag-and-drop</p>
            </div>
            <button id="closeProcessBtn" onclick="closeProcessModal()"
                class="p-2 hover:bg-accent rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Sidebar - Process List -->
            <div id="leftSidebar"
                class="w-80 border-r border-border bg-secondary/30 flex flex-col transition-all duration-200">
                <div class="p-4 border-b border-border flex-shrink-0">
                    <button id="addProcessBtn" onclick="processGraph.showAddProcessModal()"
                        class="w-full inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-600/90">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Process
                    </button>
                </div>

                <!-- Process List - Scrollable -->
                <div id="processListContainer" class="flex-1 overflow-y-auto p-4 min-h-0">
                    <div id="processList" class="grid gap-3"
                        style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                        <!-- Process items will be added here -->
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div id="resizeHandle"
                class="w-1 bg-border hover:bg-border/80 cursor-col-resize flex items-center justify-center group transition-colors relative"
                title="Drag to resize (10% - 90% of viewport)">
                <!-- Vertical line indicator -->
                <div class="absolute left-1/2 top-0 bottom-0 w-px bg-border group-hover:bg-border/80 transition-colors">
                </div>
                <!-- Drag indicator icons -->
                <div class="flex flex-col gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="w-3 h-3 text-muted-foreground" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="3" r="1.5" />
                        <circle cx="10" cy="10" r="1.5" />
                        <circle cx="10" cy="17" r="1.5" />
                    </svg>
                </div>
                <!-- Resize limits indicator -->
                <div
                    class="absolute bottom-2 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <div
                        class="text-[10px] text-muted-foreground bg-background/90 px-1.5 py-0.5 rounded border shadow-sm whitespace-nowrap">
                        10% ⟷ 90%
                    </div>
                </div>
            </div>

            <!-- Graph Canvas -->
            <div id="canvasContainer"
                class="flex-1 relative bg-gradient-to-br from-slate-50 to-slate-100 transition-all duration-200">
                <svg id="processGraphCanvas" class="w-full h-full" style="cursor: move;">
                    <!-- Connections will be drawn here -->
                    <defs>
                        <!-- Arrow marker for connections -->
                        <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8"
                            orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 L 3 5 z" fill="#64748b" />
                        </marker>
                        <marker id="arrowhead-active" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8"
                            markerHeight="8" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 L 3 5 z" fill="#10b981" />
                        </marker>
                    </defs>
                    <g id="connectionsLayer"></g>
                    <g id="nodesLayer"></g>
                </svg>

                <!-- Graph Controls -->
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <button onclick="toggleConnectionMode()" id="connectionModeBtn"
                        class="p-2 bg-card border border-border rounded-md hover:bg-accent transition-colors shadow-sm"
                        title="Click to connect: Right diamond (FROM) → Left circle (TO)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                        </svg>
                    </button>
                </div>

                <!-- Connection Mode Indicator -->
                <div id="connectionModeIndicator"
                    class="absolute bottom-4 left-4 hidden px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-lg shadow-xl flex items-center gap-3 border border-emerald-400">
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-border bg-card flex justify-between items-center">
            <div class="text-sm text-muted-foreground">
                <span id="processCount">0</span> processes • <span id="connectionCount">0</span> connections
            </div>
            <div class="flex gap-3">
                <button id="footerCloseBtn" onclick="closeProcessModal()"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Process Modal -->
<div id="addProcessModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center" role="dialog"
    aria-modal="true" aria-labelledby="addProcessModalTitle">
    <div class="bg-card w-full max-w-5xl rounded-lg shadow-xl max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-border flex items-center justify-between flex-shrink-0">
            <div>
                <h3 id="addProcessModalTitle" class="text-xl font-semibold">
                    Add New Process
                    <span class="ml-1.5 px-1 py-0.5 text-[10px] font-medium bg-blue-100 text-blue-700 rounded">comp
                        #8239jhrnf</span>
                </h3>
                <p class="text-sm text-muted-foreground mt-1">Create a process with one or more provider contracts</p>
            </div>
            <button onclick="processGraph.closeAddProcessModal()"
                class="p-2 hover:bg-accent rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <form id="createProcessForm" onsubmit="return handleCreateProcess(event)" class="space-y-6">
                <!-- Process Name -->
                <div>
                    <label class="block text-sm font-medium mb-2">Process Name *</label>
                    <input type="text" id="newProcessName" required
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"
                        placeholder="e.g., Credit Check (Acquisition)">
                    <p class="text-sm text-muted-foreground mt-2">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Process names can be reused for different providers
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="newProcessDescription" rows="3" placeholder="Brief description"
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"></textarea>
                </div>

                <!-- Contracts Section -->
                <div class="border-t border-border pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold">Select Provider/Vendor</h4>
                    </div>

                    <!-- Provider Selection -->
                    <div id="addProviderSelectSection" class="mb-3">
                        <div class="flex items-center gap-3">
                            <select id="addNewProviderSelect" class="flex-1 px-3 py-2 border border-input rounded-md">
                            </select>
                            <button type="button" onclick="processGraph.addProviderToAdd()"
                                class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">
                                Add
                            </button>
                        </div>
                        <p class="text-xs text-muted-foreground mt-2">Each provider can only have one contract per
                            process</p>
                    </div>

                    <!-- Contracts Container -->
                    <div id="addContractsContainer" class="space-y-4">
                        <!-- Empty state -->
                        <div id="addContractsEmpty"
                            class="p-8 border-2 border-dashed border-border rounded-lg bg-secondary/10 text-center">
                            <svg class="w-12 h-12 text-muted-foreground mx-auto mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <p class="text-sm text-muted-foreground">No contracts added yet</p>
                            <p class="text-xs text-muted-foreground mt-1">Add at least one contract with a provider</p>
                        </div>
                    </div>

                    <p class="text-sm text-muted-foreground mt-4 flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Each contract represents a provider with custom tier pricing for this process</span>
                    </p>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-border bg-card flex justify-end gap-3 flex-shrink-0">
            <button type="button" onclick="processGraph.closeAddProcessModal()"
                class="px-5 py-2.5 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition-colors">
                Cancel
            </button>
            <button type="submit" form="createProcessForm"
                class="px-5 py-2.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors">
                Create Process & Contracts
            </button>
        </div>
    </div>
</div>

<!-- Edit Process Modal -->
<div id="editProcessModal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center" role="dialog"
    aria-modal="true" aria-labelledby="editProcessModalTitle">
    <div class="bg-card w-full max-w-4xl rounded-lg shadow-xl max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-border flex items-center justify-between flex-shrink-0">
            <div>
                <h3 id="editProcessModalTitle" class="text-xl font-semibold">
                    Edit Process
                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded">comp
                        #akjsdfhiu</span>
                </h3>
                <p class="text-sm text-muted-foreground mt-1">Update process name, description, and volume tiers</p>
            </div>
            <button onclick="processGraph.closeEditProcessModal()"
                class="p-2 hover:bg-accent rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <form id="editProcessForm" onsubmit="return processGraph.handleEditProcessSubmit(event)" class="space-y-6">
                <input type="hidden" id="editProcessId">

                <!-- Process / Contract Name -->
                <div>
                    <label class="block text-sm font-medium mb-2">Process / Contract Name *</label>
                    <input type="text" id="editProcessName" required
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"
                        placeholder="e.g., Credit Check (Acquisition)">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="editProcessDescription" rows="3" placeholder="Brief description"
                        class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent"></textarea>
                </div>

                <!-- Contracts Section -->
                <div class="border-t border-border pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold">Contracts for this Process</h4>
                    </div>

                    <!-- Provider Selection -->
                    <div id="editProviderSelectSection" class="mb-3">
                        <div class="flex items-center gap-3">
                            <select id="editNewProviderSelect" class="flex-1 px-3 py-2 border border-input rounded-md">
                            </select>
                            <button type="button" onclick="processGraph.addProviderToEdit()"
                                class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">
                                Add
                            </button>
                        </div>
                        <p class="text-xs text-muted-foreground mt-2">Each provider can only have one contract per
                            process</p>
                    </div>

                    <!-- Contracts Container -->
                    <div id="editContractsContainer" class="space-y-4">
                        <!-- Empty state -->
                        <div id="editContractsEmpty"
                            class="p-8 border-2 border-dashed border-border rounded-lg bg-secondary/10 text-center">
                            <svg class="w-12 h-12 text-muted-foreground mx-auto mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <p class="text-sm text-muted-foreground">No contracts found for this process</p>
                            <p class="text-xs text-muted-foreground mt-1">Add providers to create contracts</p>
                        </div>
                    </div>

                    <p class="text-sm text-muted-foreground mt-4 flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Each contract represents a provider with custom tier pricing for this process</span>
                    </p>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-border bg-card flex justify-end gap-3 flex-shrink-0">
            <button type="button" onclick="processGraph.closeEditProcessModal()"
                class="px-5 py-2.5 border border-input rounded-md hover:bg-accent hover:text-accent-foreground transition-colors">
                Cancel
            </button>
            <button type="submit" form="editProcessForm"
                class="px-5 py-2.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-colors">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Set current process ID for JavaScript filtering -->
{% if current_process %}
<script>
    window.CURRENT_PROCESS_ID = {{ current_process.process_id }};
</script>
{% else %}
<script>
    window.CURRENT_PROCESS_ID = null;
</script>
{% endif %}

<!-- Component Scripts (in dependency order) -->
<script src="/static/contracts/js/dataService.js"></script>
<script src="/static/contracts/js/tierManager.js"></script>
<script src="/static/contracts/js/offerManager.js"></script>
<script src="/static/contracts/js/uiManager.js"></script>
<script src="/static/contracts/js/modalManager.js"></script>
<script src="/static/contracts/js/tableRenderer.js"></script>
<script src="/static/contracts/js/formHandler.js"></script>
<script src="/static/contracts/js/processGraphView.js"></script>
<script src="/static/contracts/js/processMenuView.js"></script>
<script src="/static/contracts/js/processGraphEdit.js"></script>
<script src="/static/contracts/js/contractsApp.js"></script>
{% endblock %}