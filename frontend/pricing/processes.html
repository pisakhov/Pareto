{% extends "base.html" %}

{% block title %}Pareto - Processes{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="py-4">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-foreground">Process Flows</h1>
            </div>
            <button id="showProcessBtn" onclick="showProcessModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2 bg-[#023047] text-white hover:bg-[#023047]/90">
                <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                Add Process
            </button>
        </div>
    </div>

    <!-- Compact Process Graph -->
    <div class="bg-card border rounded-lg p-4" style="height: 500px;">
        <div id="processGraph" style="width: 100%; height: 100%;"></div>
    </div>

    <!-- Process List for Navigation -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
        {% for process in processes %}
        <a href="/pricing/{{ process.process_id }}" class="block group">
            <div class="bg-card border rounded-lg p-4 hover:border-emerald-500 transition-all">
                <div class="text-center">
                    <h3 class="text-sm font-semibold text-foreground group-hover:text-emerald-600 transition-colors">
                        {{ process.process_name }}
                    </h3>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mt-1
                        {% if process.status == 'active' %}
                            bg-emerald-100 text-emerald-800
                        {% else %}
                            bg-gray-100 text-gray-800
                        {% endif %}">
                        {{ process.status }}
                    </span>
                </div>
            </div>
        </a>
        {% endfor %}

        {% if not processes %}
        <div class="col-span-full">
            <div class="bg-card border rounded-lg p-8 text-center">
                <svg class="w-8 h-8 mx-auto text-muted-foreground mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-muted-foreground text-sm">No processes yet. Click "Add Process" to create one.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Process Modal with Graph Editor -->
<div id="processModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="processModalTitle">
    <div class="bg-card w-full h-full flex flex-col">
        <!-- Header -->
        <div class="p-6 border-b border-border flex items-center justify-between">
            <div>
                <h3 id="processModalTitle" class="text-2xl font-bold">Process Graph Editor</h3>
                <p class="text-sm text-muted-foreground mt-1">Design process flows with drag-and-drop</p>
            </div>
            <button id="closeProcessBtn" onclick="closeProcessModal()" class="p-2 hover:bg-accent rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Main Content: Sidebar + Graph -->
        <div class="flex flex-1" style="min-height: 0;">
            <!-- Sidebar with Process List -->
            <div class="w-80 border-r border-border flex flex-col bg-card">
                <div class="p-4 border-b border-border">
                    <button id="addProcessBtn" onclick="toggleAddProcessForm()" class="w-full inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-9 px-3 py-2 bg-emerald-600 text-white hover:bg-emerald-600/90">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Process
                    </button>
                </div>

                <!-- Add Process Form -->
                <div id="addProcessForm" class="hidden p-4 border-b border-border">
                    <form id="createProcessForm" onsubmit="return handleCreateProcess(event)" class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium mb-1">Process Name *</label>
                            <input type="text" id="newProcessName" required
                                   class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent text-sm"
                                   placeholder="e.g., Marketing">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Description</label>
                            <textarea id="newProcessDescription" rows="2"
                                      class="w-full px-3 py-2 border border-input rounded-md focus:ring-2 focus:ring-ring focus:border-transparent text-sm"
                                      placeholder="Brief description"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-9 px-3 py-2 bg-emerald-600 text-white hover:bg-emerald-600/90">
                                Create
                            </button>
                            <button type="button" id="cancelAddProcessBtn" onclick="toggleAddProcessForm()" class="flex-1 inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-9 px-3 py-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex-1 overflow-y-auto p-4">
                    <div id="processList" class="space-y-2">
                        <!-- Process items will be added here -->
                    </div>
                </div>
            </div>

            <!-- Graph Canvas -->
            <div class="flex-1 relative bg-gradient-to-br from-slate-50 to-slate-100">
                <svg id="processGraphCanvas" class="w-full h-full" style="cursor: move;">
                    <defs>
                        <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 L 3 5 z" fill="#64748b" />
                        </marker>
                        <marker id="arrowhead-active" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
                            <path d="M 0 0 L 10 5 L 0 10 L 3 5 z" fill="#10b981" />
                        </marker>
                    </defs>
                    <g id="connectionsLayer"></g>
                    <g id="nodesLayer"></g>
                </svg>
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <button onclick="toggleConnectionMode()" id="connectionModeBtn" class="p-2 bg-card border border-border rounded-md hover:bg-accent transition-colors shadow-sm" title="Connect Processes">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer with Controls -->
        <div class="p-4 border-t border-border bg-muted/30">
            <div class="flex items-center justify-between text-sm">
                <div class="flex items-center gap-4 text-muted-foreground">
                    <span><span id="processCount">0</span> processes â€¢ <span id="connectionCount">0</span> connections</span>
                </div>
                <div class="flex gap-3">
                    <button id="footerCloseBtn" onclick="closeProcessModal()" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<!-- Scripts for Process Modal -->
<script src="/static/pricing/js/dataService.js"></script>
<script src="/static/pricing/js/processGraphView.js"></script>
<script src="/static/pricing/js/processGraphEdit.js"></script>
<script src="/static/pricing/js/modalManager.js"></script>
<script src="/static/pricing/js/uiManager.js"></script>

{% endblock %}
